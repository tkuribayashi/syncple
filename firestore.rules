rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザードキュメント: 本人のみ読み書き可能、ペアのパートナーは読み取り可能
    match /users/{userId} {
      // 本人は読み書き可能
      allow write: if request.auth != null && request.auth.uid == userId;

      // 本人、またはペアのパートナーは読み取り可能
      allow read: if request.auth != null &&
        (request.auth.uid == userId ||  // 本人
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pairId != null &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pairId ==
          get(/databases/$(database)/documents/users/$(userId)).data.pairId));  // ペアのパートナー
    }

    // ペアドキュメント: ペアのメンバーのみアクセス可能
    match /pairs/{pairId} {
      // 個別ドキュメントの読み取り: ペアのメンバーまたはuser2Idがnullの場合
      allow get: if request.auth != null &&
        (resource.data.user1Id == request.auth.uid ||
         resource.data.user2Id == request.auth.uid ||
         resource.data.user2Id == null);

      // クエリ/リスト: 認証済みユーザーは検索可能（個別の読み取り権限は上記getで制御）
      allow list: if request.auth != null;

      allow create: if request.auth != null;

      // ペアのメンバーは更新可能
      // または、user2Idがnullでuser2Idを設定する場合も更新可能（ペア参加）
      allow update: if request.auth != null &&
        (resource.data.user1Id == request.auth.uid ||
         resource.data.user2Id == request.auth.uid ||
         (resource.data.user2Id == null && request.resource.data.user2Id == request.auth.uid));

      // メッセージサブコレクション: 特別なルール
      match /messages/{messageId} {
        // ペアのメンバーは読み取りと作成が可能
        allow read, create: if request.auth != null &&
          (get(/databases/$(database)/documents/pairs/$(pairId)).data.user1Id == request.auth.uid ||
           get(/databases/$(database)/documents/pairs/$(pairId)).data.user2Id == request.auth.uid);

        // 更新は以下の場合に許可:
        // 1. 既読マーク（自分が送信していないメッセージのみ）
        // 2. リアクション（reactionsフィールドのみ）
        allow update: if request.auth != null &&
          (get(/databases/$(database)/documents/pairs/$(pairId)).data.user1Id == request.auth.uid ||
           get(/databases/$(database)/documents/pairs/$(pairId)).data.user2Id == request.auth.uid) &&
          (
            // 既読マークの更新（自分が送信していないメッセージのみ）
            (resource.data.senderId != request.auth.uid &&
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt'])) ||
            // リアクションの更新（reactionsフィールドのみ）
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions'])
          );

        // 削除は送信者のみ可能
        allow delete: if request.auth != null && resource.data.senderId == request.auth.uid;
      }

      // その他のサブコレクション: ペアのメンバーのみアクセス可能
      match /{subcollection}/{docId} {
        allow read, write: if request.auth != null &&
          subcollection != 'messages' &&
          (get(/databases/$(database)/documents/pairs/$(pairId)).data.user1Id == request.auth.uid ||
           get(/databases/$(database)/documents/pairs/$(pairId)).data.user2Id == request.auth.uid);
      }
    }
  }
}
